# title: Demonstration pipeline
# variables: []
# secrets: []
name: Demo

on:
  workflow_dispatch: {}

jobs:
  quick-check:
    name: Quick check
    runs-on: ubuntu-latest
    steps:
      - name: Add this runner IP to Atlas Project IP Access List (temporary)
        env:
          ATLAS_PUBLIC_KEY:  ${{ secrets.ATLAS_PUBLIC_KEY }}
          ATLAS_PRIVATE_KEY: ${{ secrets.ATLAS_PRIVATE_KEY }}
          ATLAS_GROUP_ID:    ${{ secrets.ATLAS_GROUP_ID }}
        run: |
          # Step 1: Get current outbound IP of this runner
          RUNNER_IP=$(curl -s https://api.ipify.org || curl -s https://ifconfig.me)

          if [ -z "$RUNNER_IP" ]; then
            echo "Failed to detect runner IP"
            exit 1
          fi

          echo "Detected runner IP: $RUNNER_IP"

          # Step 2: Prepare JSON payload (single /32 entry, temporary delete after 1 hour)
          # Use ISO 8601 UTC for deleteAfterDate (current time + 3600s)
          DELETE_AFTER=$(date -u -d '+3600 seconds' +"%Y-%m-%dT%H:%M:%SZ")

          PAYLOAD="[{\"ipAddress\": \"$RUNNER_IP\", \"comment\": \"GH Actions temp - run ${{ github.run_id }}\", \"deleteAfterDate\": \"$DELETE_AFTER\"}]"

          # Step 3: Call Atlas API v2 to add the entry
          # Uses Digest Auth via curl
          RESPONSE=$(curl -s -w "%{http_code}" --user "$ATLAS_PUBLIC_KEY:$ATLAS_PRIVATE_KEY" --digest \
            -H "Accept: application/vnd.atlas.2023-01-01+json" \
            -H "Content-Type: application/json" \
            --data "$PAYLOAD" \
            "https://cloud.mongodb.com/api/atlas/v2/groups/$ATLAS_GROUP_ID/accessList")

          HTTP_CODE=${RESPONSE: -3}
          BODY=${RESPONSE%???}

          echo "API response code: $HTTP_CODE"
          echo "API response body: $BODY"

          if [[ "$HTTP_CODE" != "200" ]]; then
            echo "Failed to add IP to Atlas access list (code $HTTP_CODE)"
            exit 1
          fi

          echo "Successfully added temporary IP $RUNNER_IP to Atlas access list (auto-deletes ~1h)"
      - name: Clone repository
        uses: actions/checkout@v6
      - name: Cache Terraform plugins
        uses: actions/cache@v5
        with:
          path: |
            ~/.terraform.d/plugin-cache
          key: terraform-${{ hashFiles('**/.terraform.lock.hcl') }}
      - name: Install terraform
        uses: hashicorp/setup-terraform@v3
      # - name: Terraform Init
      #   run: terraform init
